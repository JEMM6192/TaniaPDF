import{d as m,c as f,r as C,o as b,w as y,a as c}from"./runtime-core.esm-bundler.BMoPEwju.js";if(typeof window<"u"){class h extends HTMLElement{pdfDoc=null;currentPage=1;scale=1;marcas=[];isMarcando=!1;currentMarca=null;selectedMarkIndex=null;isPanning=!1;startPan={x:0,y:0};startScroll={left:0,top:0};baseUrl="/";viewerContainer;pdfCanvas;overlayCanvas;ctxPdf;ctxOverlay;connectedCallback(){this.baseUrl=this.getAttribute("base-url")||"/",pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.7.107/pdf.worker.min.js";const t=this.querySelector("#viewerContainer"),e=this.querySelector("#pdfCanvas"),s=this.querySelector("#overlayCanvas");if(!t||!e||!s){console.error("No se encontraron los elementos necesarios en el visor.");return}this.viewerContainer=t,this.pdfCanvas=e,this.overlayCanvas=s,this.ctxPdf=this.pdfCanvas.getContext("2d"),this.ctxOverlay=this.overlayCanvas.getContext("2d"),this.initializeEvents()}initializeEvents(){this.querySelector("#btnAbrir")?.addEventListener("click",()=>this.openPDF()),this.querySelector("#btnZoomIn")?.addEventListener("click",()=>{this.scale*=1.1,this.renderPage(this.currentPage)}),this.querySelector("#btnZoomOut")?.addEventListener("click",()=>{this.scale/=1.1,this.renderPage(this.currentPage)}),this.querySelector("#btnAgregarMarca")?.addEventListener("click",()=>{this.isMarcando=!0,this.overlayCanvas.style.cursor="crosshair"}),this.querySelector("#btnImprimir")?.addEventListener("click",()=>this.imprimirMarcas()),this.querySelector("#btnGuardar")?.addEventListener("click",()=>this.guardarMarcas()),this.overlayCanvas.addEventListener("mousedown",a=>this.startMarking(a)),this.overlayCanvas.addEventListener("mousemove",a=>this.updateMarking(a)),this.overlayCanvas.addEventListener("mouseup",a=>this.finishMarking(a)),this.viewerContainer.addEventListener("mousedown",a=>this.startPanning(a)),window.addEventListener("mousemove",a=>this.doPanning(a)),window.addEventListener("mouseup",a=>this.stopPanning(a))}openPDF(){const t=document.createElement("input");t.type="file",t.accept="application/pdf",t.onchange=()=>{const e=t.files?t.files[0]:null;if(e){const s=new FileReader;s.onload=()=>{const r=new Uint8Array(s.result);pdfjsLib.getDocument(r).promise.then(n=>{this.pdfDoc=n,this.currentPage=1,this.scale=1,this.marcas=[],this.selectedMarkIndex=null,this.renderPage(this.currentPage)}).catch(n=>{console.error("Error al cargar PDF:",n),alert("Error al cargar el PDF. Revisa la consola.")})},s.readAsArrayBuffer(e)}},t.click()}renderPage(t){this.pdfDoc.getPage(t).then(e=>{const s=e.getViewport({scale:this.scale});this.pdfCanvas.width=s.width,this.pdfCanvas.height=s.height,this.actualizarOverlay();const r={canvasContext:this.ctxPdf,viewport:s};e.render(r).promise.then(()=>{this.dibujarMarcasFijas()})})}actualizarOverlay(){this.overlayCanvas.width=this.pdfCanvas.width,this.overlayCanvas.height=this.pdfCanvas.height}dibujarMarcasFijas(){this.ctxOverlay.clearRect(0,0,this.overlayCanvas.width,this.overlayCanvas.height),this.marcas.forEach(t=>{this.ctxOverlay.strokeStyle=t.color,this.ctxOverlay.lineWidth=2,this.ctxOverlay.setLineDash([]),this.ctxOverlay.strokeRect(t.x*this.scale,t.y*this.scale,t.width*this.scale,t.height*this.scale)}),this.updateMarksList()}updateMarksList(){const t=this.querySelector("#marksList");t&&(t.innerHTML="",this.marcas.forEach((e,s)=>{const r=document.createElement("div");r.dataset.index=s.toString();const n=document.createElement("div");n.className="colorBox",n.style.backgroundColor=e.color;const i=document.createElement("span");i.className="markLabel",i.textContent="Marca "+(s+1),i.addEventListener("click",()=>{this.selectedMarkIndex=s,t.querySelectorAll("div").forEach(o=>o.classList.remove("selected")),r.classList.add("selected")});const a=document.createElement("img");a.className="deleteBtn",a.src=this.baseUrl+"/icons/delete.svg",a.style.width="24px",a.style.height="24px",a.style.cursor="pointer",a.addEventListener("click",o=>{o.stopPropagation();const l=parseInt(r.dataset.index||"0",10);this.marcas.splice(l,1),this.selectedMarkIndex===l&&(this.selectedMarkIndex=null),this.updateMarksList(),this.dibujarMarcasFijas()}),r.appendChild(n),r.appendChild(i),r.appendChild(a),t.appendChild(r)}))}startMarking(t){if(this.isMarcando){const e=this.overlayCanvas.getBoundingClientRect();this.currentMarca={startX:t.clientX-e.left,startY:t.clientY-e.top}}}updateMarking(t){if(this.isMarcando&&this.currentMarca){const e=this.overlayCanvas.getBoundingClientRect(),s=t.clientX-e.left,r=t.clientY-e.top;this.dibujarMarcasFijas(),this.ctxOverlay.save(),this.ctxOverlay.strokeStyle="black",this.ctxOverlay.setLineDash([5,3]);const n=s-this.currentMarca.startX,i=r-this.currentMarca.startY;this.ctxOverlay.strokeRect(this.currentMarca.startX,this.currentMarca.startY,n,i),this.ctxOverlay.restore()}}finishMarking(t){if(this.isMarcando&&this.currentMarca){const e=this.overlayCanvas.getBoundingClientRect(),s=t.clientX-e.left,r=t.clientY-e.top,n=Math.min(this.currentMarca.startX,s)/this.scale,i=Math.min(this.currentMarca.startY,r)/this.scale,a=Math.abs(s-this.currentMarca.startX)/this.scale,o=Math.abs(r-this.currentMarca.startY)/this.scale,l=["red","blue","green","orange","purple","brown"],v=l[this.marcas.length%l.length];this.marcas.push({x:n,y:i,width:a,height:o,color:v}),this.isMarcando=!1,this.currentMarca=null,this.overlayCanvas.style.cursor="default",this.dibujarMarcasFijas()}}startPanning(t){this.isMarcando||(this.isPanning=!0,this.viewerContainer.style.cursor="grabbing",this.startPan={x:t.clientX,y:t.clientY},this.startScroll={left:this.viewerContainer.scrollLeft,top:this.viewerContainer.scrollTop})}doPanning(t){if(this.isPanning){const e=t.clientX-this.startPan.x,s=t.clientY-this.startPan.y;this.viewerContainer.scrollLeft=this.startScroll.left-e,this.viewerContainer.scrollTop=this.startScroll.top-s}}stopPanning(t){this.isPanning&&(this.isPanning=!1,this.viewerContainer.style.cursor="grab")}exportMarca(t,e){this.pdfDoc.getPage(this.currentPage).then(r=>{const n=r.getViewport({scale:3}),i=document.createElement("canvas");i.width=n.width,i.height=n.height;const o={canvasContext:i.getContext("2d"),viewport:n};r.render(o).promise.then(()=>{const l=t.x*3,v=t.y*3,u=t.width*3,p=t.height*3,g=document.createElement("canvas");g.width=u,g.height=p,g.getContext("2d")?.drawImage(i,l,v,u,p,0,0,u,p),e(g.toDataURL("image/png"),u,p)})})}imprimirMarcas(){if(this.marcas.length===0){alert("No hay marcas para imprimir.");return}const{jsPDF:t}=jspdf;let e=null,s=0;const r=n=>{this.exportMarca(this.marcas[n],(i,a,o)=>{const l=a>o?"landscape":"portrait";if(n===0?(e=new t({orientation:l,unit:"px",format:[a,o]}),e.addImage(i,"PNG",0,0,a,o)):(e.addPage([a,o],l),e.addImage(i,"PNG",0,0,a,o)),s++,s===this.marcas.length){const v=e.output("blob"),u=URL.createObjectURL(v);window.open(u,"_blank")}else r(n+1)})};r(0)}guardarMarcas(){if(this.marcas.length===0){alert("No hay marcas para guardar.");return}const{jsPDF:t}=jspdf;let e=null,s=0;const r=n=>{this.exportMarca(this.marcas[n],(i,a,o)=>{const l=a>o?"landscape":"portrait";n===0?(e=new t({orientation:l,unit:"px",format:[a,o]}),e.addImage(i,"PNG",0,0,a,o)):(e.addPage([a,o],l),e.addImage(i,"PNG",0,0,a,o)),s++,s===this.marcas.length?e.save("marcas.pdf"):r(n+1)})};r(0)}}customElements.define("pdf-viewer-element",h)}const x=(h,d)=>{const t=h.__vccOpts||h;for(const[e,s]of d)t[e]=s;return t},M="pdf-viewer-element",w=m({__name:"ClientPDFViewer",setup(h,{expose:d}){d();const t={customEl:M};return Object.defineProperty(t,"__isScriptSetup",{enumerable:!1,value:!0}),t}});function P(h,d,t,e,s,r){return b(),f(C(e.customEl),{"base-url":"/TaniaPDF"},{default:y(()=>d[0]||(d[0]=[c("div",{id:"mainContainer"},[c("div",{id:"viewerContainer"},[c("div",{id:"pdfContainer"},[c("canvas",{id:"pdfCanvas"}),c("canvas",{id:"overlayCanvas"})])]),c("div",{id:"controlPanel"},[c("button",{id:"btnAbrir"},"Abrir PDF"),c("button",{id:"btnZoomIn"},"Acercar"),c("button",{id:"btnZoomOut"},"Alejar"),c("button",{id:"btnAgregarMarca"},"Agregar Marca"),c("button",{id:"btnImprimir"},"Imprimir"),c("button",{id:"btnGuardar"},"Guardar"),c("div",{id:"marksListContainer"},[c("div",{id:"marksList"})])])],-1)])),_:1})}const E=x(w,[["render",P]]);export{E as default};
