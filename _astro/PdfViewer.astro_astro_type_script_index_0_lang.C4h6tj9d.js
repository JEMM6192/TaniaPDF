document.addEventListener("DOMContentLoaded",()=>{let y=null,b=1,d=1;const m=document.getElementById("pdfCanvas"),S=m?.getContext("2d"),c=document.getElementById("overlayCanvas"),i=c?.getContext("2d"),f=document.getElementById("viewerContainer");let k="",u=[],v=!1,g=null,w=!1,I={x:0,y:0},B={left:0,top:0};function G(){c&&m&&(c.width=m.width,c.height=m.height)}function P(t){y&&y.getPage(t).then(function(a){const e=a.getViewport({scale:d});m&&(m.width=e.width,m.height=e.height),G();const n={canvasContext:S,viewport:e};a.render(n).promise.then(function(){x()})})}function x(){!i||!c||(i.clearRect(0,0,c.width,c.height),u.forEach(t=>{i&&(i.strokeStyle=t.color,i.lineWidth=2,i.setLineDash([]),i.strokeRect(t.x*d,t.y*d,t.width*d,t.height*d))}),M())}function M(){const t=document.getElementById("marksList");t&&(t.innerHTML="",u.forEach((a,e)=>{const n=document.createElement("div");n.dataset.index=e.toString();const r=document.createElement("div");r.className="colorBox",r.style.backgroundColor=a.color;const o=document.createElement("span");o.className="markLabel",o.textContent="Marca "+(e+1),o.addEventListener("click",()=>{t&&t.querySelectorAll("div").forEach(l=>l.classList.remove("selected")),n.classList.add("selected")});const s=document.createElement("img");s.className="deleteBtn",s.src="icons/delete.svg",s.addEventListener("click",l=>{if(l.stopPropagation(),n.dataset.index){const h=parseInt(n.dataset.index,10);u.splice(h,1),M(),x()}}),n.appendChild(r),n.appendChild(o),n.appendChild(s),t.appendChild(n)}))}function X(t,a){if(!y)return;const e=3;y.getPage(b).then(function(n){const r=n.getViewport({scale:e}),o=document.createElement("canvas");o.width=r.width,o.height=r.height;const l={canvasContext:o.getContext("2d"),viewport:r};n.render(l).promise.then(function(){const h=t.x*e,p=t.y*e,E=t.width*e,L=t.height*e,C=document.createElement("canvas");C.width=E,C.height=L;const A=C.getContext("2d");A&&A.drawImage(o,h,p,E,L,0,0,E,L),a(C.toDataURL("image/png"),E,L)})})}const Y=document.getElementById("btnAbrir");Y&&Y.addEventListener("click",()=>{const t=document.createElement("input");t.type="file",t.accept="application/pdf",t.onchange=a=>{const e=a.target;if(e&&e.files&&e.files[0]){const n=e.files[0];k=n.name;const r=new FileReader;r.onload=function(){const o=new Uint8Array(this.result);pdfjsLib.getDocument(o).promise.then(function(s){y=s,b=1,d=1,u=[],P(b)}).catch(function(s){console.error("Error al cargar PDF:",s),alert("Error al cargar el PDF. Revisa la consola.")})},r.readAsArrayBuffer(n)}},t.click()});const R=document.getElementById("btnZoomIn");R&&R.addEventListener("click",()=>{d*=1.1,P(b)});const N=document.getElementById("btnZoomOut");N&&N.addEventListener("click",()=>{d/=1.1,P(b)});const D=document.getElementById("btnAgregarMarca");D&&D.addEventListener("click",()=>{v=!0,c&&(c.style.cursor="crosshair")});const F=document.getElementById("btnImprimir");F&&F.addEventListener("click",()=>{if(u.length===0){alert("No hay marcas para imprimir.");return}let t=null,a=0;function e(n){X(u[n],(r,o,s)=>{const l=o>s?"landscape":"portrait",{jsPDF:h}=jspdf;if(n===0?(t=new h({orientation:l,unit:"px",format:[o,s]}),t.addImage(r,"PNG",0,0,o,s)):(t.addPage([o,s],l),t.addImage(r,"PNG",0,0,o,s)),a++,a===u.length){const p=t.output("blob"),E=URL.createObjectURL(p);window.open(E,"_blank")}else e(n+1)})}e(0)});const j=document.getElementById("btnGuardar");j&&j.addEventListener("click",()=>{if(u.length===0){alert("No hay marcas para guardar.");return}let t=null,a=0;function e(n){X(u[n],(r,o,s)=>{const l=o>s?"landscape":"portrait",{jsPDF:h}=jspdf;if(n===0?(t=new h({orientation:l,unit:"px",format:[o,s]}),t.addImage(r,"PNG",0,0,o,s)):(t.addPage([o,s],l),t.addImage(r,"PNG",0,0,o,s)),a++,a===u.length){const p=k.replace(/\.[^/.]+$/,"");t.save(p)}else e(n+1)})}e(0)}),c&&(c.addEventListener("mousedown",t=>{if(v){const a=c.getBoundingClientRect();g={startX:t.clientX-a.left,startY:t.clientY-a.top}}}),c.addEventListener("mousemove",t=>{if(v&&g&&i){const a=c.getBoundingClientRect(),e=t.clientX-a.left,n=t.clientY-a.top;x(),i.save(),i.strokeStyle="black",i.setLineDash([5,3]);const r=e-g.startX,o=n-g.startY;i.strokeRect(g.startX,g.startY,r,o),i.restore()}}),c.addEventListener("mouseup",t=>{if(v&&g){const a=c.getBoundingClientRect(),e=t.clientX-a.left,n=t.clientY-a.top,r=Math.min(g.startX,e)/d,o=Math.min(g.startY,n)/d,s=Math.abs(e-g.startX)/d,l=Math.abs(n-g.startY)/d,h=["red","blue","green","orange","purple","brown"],p=h[u.length%h.length];u.push({x:r,y:o,width:s,height:l,color:p}),v=!1,g=null,c&&(c.style.cursor="default"),x()}})),f&&f.addEventListener("mousedown",t=>{v||(w=!0,f&&(f.style.cursor="grabbing"),I={x:t.clientX,y:t.clientY},f&&(B={left:f.scrollLeft,top:f.scrollTop}))}),window.addEventListener("mousemove",t=>{if(w&&f){const a=t.clientX-I.x,e=t.clientY-I.y;f.scrollLeft=B.left-a,f.scrollTop=B.top-e}}),window.addEventListener("mouseup",()=>{w&&f&&(w=!1,f.style.cursor="grab")})});
